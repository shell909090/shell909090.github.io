<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>ipv6试用手记</title>

  
  
  <link rel="stylesheet" href="http://shell909090.org/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link href="http://shell909090.org/favicon.png" rel="icon">

  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="">

  
  <meta name="generator" content="Hugo 0.17-DEV" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://shell909090.org/">Shell&#39;s Home</a></h1>
    <h2></h2>
</hgroup></header>


<nav role="navigation">

<ul class="main-navigation">
  
  
</ul>


<ul class="subscription">
  

  
  

</ul>


</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
    <h1 class="entry-title">
         ipv6试用手记 
    </h1>
    <p class="meta">Aug 5, 2015
         - 1 minute read 
         - <a href="http://shell909090.org/blog/archives/2779/#disqus_thread">Comments</a>

        
    </p>
</header>


        <div class="entry-content">
          
          
          
          <p><h1>
 ipv6地址
</h1>
<h2>
 概要
</h2>
<p>
 挑简单的讲吧。
</p>
<p>
 ipv6地址总计128位，分为8个段，每个段16位。hex表示的话，每段最多有四位。在写出ipv6地址的时候，用:分割。所以一个经典的地址写出来是这个样子的：
</p>
<p>
 aaaa:bbbb:cccc:dddd:eeee:ffff:gggg:hhhh
</p>
<p>
 这里有两个缩写。一，如果一个数字的开始有连续的0，可以忽略。好比0001和1是一样的。二，如果有多个连续的段是0，可以缩写为::，但是只能缩写一次（这样才能确定一个唯一的地址）。例如以下是一个缩写过的地址。
</p>
<p>
 aaaa:b:c:d::1
</p>
<p>
 这个地址等同于
</p>
<p>
 aaaa:000b:000c:000d:0000:0000:0000:0001
</p>
<h2>
 ipv6地址分类
</h2>
<p>
 ::/128 未定义 ::<sup>1</sup>&frasl;<sub>128</sub> 回环地址(127.0.0.1) fe80::/10 局部地址 ::ffff:0:0/96 ipv4映射地址 ff00::/8 广播地址(其实更小，不过我的路由表里就是这样写的，全保留给他了)
</p>
<p>
 更多地址请去看wikipedia。
</p>
<h2>
 EUI-64地址
</h2>
<p>
 简单来说就是通过mac地址的48位，扩充到64位，作为ipv6地址的最后64位。
</p>
<h1>
 ipv6地址分配和基本网络设定
</h1>
<p>
 ipv6下有两种ip自动分配方案。通常都建议无状态的方案。
</p>
<h2>
 dhcp
</h2>
<p>
 一种还是经典的dhcp，这种方案分配出来的地址比较紧凑连续，空间利用率高。坏处是ip地址并不唯一固定。在多数情况下dhcp都会尽力分配和上次一样的ip下来。但是在地址池比较满和系统缓存被清理的情况下，并没有保证。
</p>
<p>
 在interfaces里，dhcp的写法大致如下：
</p>
<p>
 iface ethX inet6 dhcp
</p>
<h2>
 slaac
</h2>
<p>
 另一个是嫌地址太大的slacc。基本原理就是给一个组织（例如家里）分配一个/64的段，然后用EUI-64(似乎是)给里面的所有设备分ip。所以这样分出来的ip完全一致。
</p>
<p>
 在interfaces里，slaac的写法大致如下：
</p>
<p>
 iface ethX inet6 auto
</p>
<h2>
 dns
</h2>
<p>
 ipv6里进行配置还需要注意一点，你的DNS需要支持AAAA记录。不然拿着网址查出一个ipv4记录来就很尴尬，还得退化到ipv4去访问。这和直接使用ipv4没什么区别，反而更糟。
</p>
<p>
 实际上，大部分DNS都支持AAAA记录，只是程序会不会默认去查而已。
</p>
<p>
 另一个问题是，如果你的DNS服务器地址是ipv4的，也会使得你无法完全脱离ipv4网络。因此需要一个有ipv6地址的DNS。一般你的ipv6链路供应商会提供一个ipv6的DNS。
</p>
<h2>
 firewall
</h2>
<p>
 slaac使用icmpv6，所以需要在防火墙上打开icmpv6协议的进入。
</p>
<h1>
 tunnel breaker
</h1>
<p>
 he提供一个6to4的tunnel，但是需要你有静态ip地址。(其实凭心而论这真不是一个太高的要求，很多VPS供应商完全可以直接搞一个48的段给自己的机房分64的段)作为普通用户，没有静态地址怎么办？那就只有用vps先接到tunnel，然后再tunnel回家了。
</p>
<h2>
 tunnel to he
</h2>
<p>
 很容易，配一根6to4的tunnel就好。tunnel breaker的网站上还很贴心的提供了不同系统下的详细配置。
</p>
<p>
 这里特别提一下。HE很贴心的提供了两段地址。一段ipv6是你和HE的隧道地址。另一段地址也会路由给你，这才是你内部应当使用的ip地址群。所以原则上说，你可以在隧道中使用(本来应当在)你和HE之间使用的地址的部分。
</p>
<h2>
 tunnel to yourself
</h2>
<p>
 先随便打一根二层的隧道。
</p>
<p>
 二层的理由是，如果使用三层隧道，那么隧道本身就需要察知ip。于是ipv6的支持就变成隧道的事了。而二层的隧道并不需要知道上面跑什么协议。
</p>
<p>
 最简单的当然是gre隧道。但是gre隧道需要在远端确定本地ip地址，这和直接打一根tunnel回家没什么区别。
</p>
<p>
 我用的方法是用任何一种二层或三层vpn打到vps上，然后上面再跑gre。这样一举解决了加密和静态地址的问题，顺便还解决了ipv6兼容性的问题。当然，代价也很高。由于是在vpn里套gre，所以头部很大，mtu就要开的比较小。
</p>
<p>
 另一个玩法是用ipsec的tunnel模式打通两个网段，于是gre也可以直接通到vps上（甚至可以直接打ipv6 tunnel）。然而ipsec的tunnel模式需要知道双端ip地址，所以其实还是没有什么用。
</p>
<p>
 顺便吐槽一下routeros的ipsec，实在是太废物了。
</p>
<p>
 当然，也可以用支持ipv6的三层隧道。PPTP都有ipv6支持。当然，我看了一眼，要把ipv6 tunnel回来还是有点问题的。
</p>
<p>
 无论怎么配置，这根隧道要用你和HE之间tunnel的部分地址。例如你和HE的tunnel是这个样子：
</p>
<p>
 a:b:c:d::<sup>1</sup>&frasl;<sub>64</sub> &lt;-&gt; a:b:c:d::<sup>2</sup>&frasl;<sub>64</sub>
</p>
<p>
 那么你可以将原来的/64改为/112，然后配置这么个tunnel地址：
</p>
<p>
 a:b:c:d::1:<sup>1</sup>&frasl;<sub>112</sub> &lt;-&gt; a:b:c:d::1:<sup>2</sup>&frasl;<sub>112</sub>
</p>
<h2>
 route
</h2>
<p>
 在vps上，需要将routed addresses指向内部的路由器。路由器需要将default路由指向vps。default指过去后其他细节就不用管了。
</p>
<h2>
 MTU
</h2>
<p>
 由于在两层隧道内跑的ipv6，因此mtu记得调整一下，否则有性能问题。
</p>
<h1>
 firewall
</h1>
<p>
 防火墙是个大头，所以要单独提出来说。
</p>
<p>
 原则上说，ipv6的所有地址都是外部可达的。因此如果你将路由器上的forward关闭，那就没有使用ipv6的意义了。然而，如果forward打开的话，那么每一台都真实的暴露在公网上了。因此每台必须都配置防火墙，否则就可能有安全问题。
</p>
<p>
 例如通常内网会打开ssh，并且不会打开防扫描，或者做安全加固。如果打开了ipv6，又没有在路由器上关闭forward，那么就会造成这个端口对全世界开放。虽然原则上说，没有人会扫描ipv6（因为一个家里的地址比全世界的ipv4还大）。但是这并不安全。因为会有人从你对外的访问地址看出你的内部机器ip。
</p>
<p>
 所以我的建议是，关闭forward，只对特定地址打开。而这些地址上，都需要保证配置了ipv6防火墙。这样即使不慎接入了一个设备，没有开防火墙。也不会造成安全隐患。当然，缺陷就是，随着接入设备的增多，你的地址列表增加很快。
</p>
<h1>
 reference
</h1>
<ul>
 <li>
  <a rel="nofollow external" href="http://wiki.mikrotik.com/wiki/Manual:IPv6/Address">
   routeros ipv6
  </a>
 </li>
 <li>
  <a href="https://en.wikipedia.org/wiki/IPv6">
   wiki IPv6
  </a>
 </li>
</ul></p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn"></span></span>
    
    <time>Aug 5, 2015</time>
    <span class="categories">
      Tags:
        
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://shell909090.org/blog/archives/2776/" title="程序员交友选择题">程序员交友选择题</a>
    

    
      <a class="basic-alignment right" href="http://shell909090.org/blog/archives/2783/" title="关于vpn的一些话">关于vpn的一些话</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'shell909090blog';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      
      
      
       
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    <section class="even">
      <h1>Recent Posts</h1>
      <ul id="recent_posts">
        
          <li class="post">
            <a href="/blog/archives/2836/">Pulau Perhentian</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2835/">唐僧被吃了</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2832/">三亚潜水体验</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2829/">潜水的一些简单解说</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2822/">一个有趣的问题</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2820/">一次升级故障的排查</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2816/">关于程序员和产品经理两大世界体系的对话——论快播庭审</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2813/">云计算的成本计算</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2809/">说说密码和安全设计</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2806/">从青蒿素得奖说现代医学里的方法论</a>
          </li>
        
      </ul>
    </section>
  

</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2016  - <a href="http://shell909090.org/license/">License</a> -
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


</body>
</html>

